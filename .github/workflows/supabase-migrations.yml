name: Auto-Apply Supabase Migrations

# Triggers when PR is merged to main
on:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**/*.sql'
  workflow_dispatch: # Manual trigger option

# Uncomment to require manual approval before applying migrations
# environment:
#   name: production
#   url: https://app.supabase.com/project/${{ secrets.SUPABASE_PROJECT_ID }}

jobs:
  # Security check before applying migrations
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Scan for unsafe patterns
        run: |
          echo "üîç Scanning migrations for security issues..."

          # Extract changed migrations to temp file
          DIFF_TEXT=$(git diff HEAD~1 HEAD -- supabase/migrations/)

          # Check for SECURITY DEFINER functions and verify search_path
          # Strategy: For each changed migration file, extract function blocks and check
          CHANGED_MIGRATIONS=$(git diff --name-only HEAD~1 HEAD -- supabase/migrations/*.sql)

          HAS_SECURITY_ISSUE=false
          for migration in $CHANGED_MIGRATIONS; do
            echo "Checking $migration..."
            
            # Extract content and look for SECURITY DEFINER functions without search_path
            if git show HEAD:$migration | grep -Pzo '(?si)create\s+(or\s+replace\s+)?function.*?security\s+definer.*?\$\$;' | grep -Pzv 'set\s+search_path'; then
              echo "::warning::‚ö†Ô∏è  $migration may contain SECURITY DEFINER without SET search_path"
              HAS_SECURITY_ISSUE=true
            fi
          done

          # Check for IN (SELECT) patterns in RLS policies
          if echo "$DIFF_TEXT" | grep -E "IN\s*\(\s*SELECT"; then
            echo "::warning::‚ö†Ô∏è  Found IN (SELECT ...) - consider using EXISTS for better performance"
          fi

          # Check for email columns without citext
          if echo "$DIFF_TEXT" | grep -i "email.*text" | grep -v "citext"; then
            echo "::warning::‚ö†Ô∏è  Found email column using TEXT - should use CITEXT"
          fi

          if [ "$HAS_SECURITY_ISSUE" = true ]; then
            echo "::warning::Please manually review SECURITY DEFINER functions in changed migrations"
          fi

          echo "‚úÖ Security scan complete"

  apply-migrations:
    name: Apply Database Migrations
    runs-on: ubuntu-latest
    needs: security-scan

    # Only run if migrations were changed
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need 2 commits to detect changes

      - name: Detect changed migrations
        id: detect-changes
        run: |
          echo "Checking for migration changes..."

          # Get list of changed migration files
          CHANGED_MIGRATIONS=$(git diff --name-only HEAD~1 HEAD | grep 'supabase/migrations/.*\.sql' || true)

          if [ -z "$CHANGED_MIGRATIONS" ]; then
            echo "No migration files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Migration files changed:"
            echo "$CHANGED_MIGRATIONS"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Save changed files for later use
            echo "$CHANGED_MIGRATIONS" > changed_migrations.txt
          fi

      - name: Setup Supabase CLI
        if: steps.detect-changes.outputs.has_changes == 'true'
        uses: supabase/setup-cli@v1
        with:
          version: 1.178.2

      - name: Apply migrations to Supabase (Production)
        if: steps.detect-changes.outputs.has_changes == 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.PRODUCTION_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "üîÑ Applying migrations to production database..."

          # Link to production project
          supabase link --project-ref $SUPABASE_PROJECT_ID

          # Apply all pending migrations
          supabase db push --password $SUPABASE_DB_PASSWORD

          echo "‚úÖ Migrations applied successfully"

      - name: Verify migration success
        if: steps.detect-changes.outputs.has_changes == 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "üîç Verifying migration status..."

          # List all migrations to confirm
          supabase migration list

          echo "‚úÖ Verification complete"

      - name: Notify on success
        if: steps.detect-changes.outputs.has_changes == 'true' && success()
        run: |
          echo "::notice::‚úÖ Database migrations applied successfully to production"
          cat changed_migrations.txt | while read file; do
            echo "::notice::  - Applied: $file"
          done

      - name: Notify on failure
        if: steps.detect-changes.outputs.has_changes == 'true' && failure()
        run: |
          echo "::error::‚ùå Failed to apply database migrations"
          echo "::error::Please check the logs and apply migrations manually"
          exit 1

  # Optional: Apply to staging environment first
  apply-migrations-staging:
    name: Apply to Staging (Optional)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    needs: security-scan

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect migration changes
        id: detect-changes-staging
        run: |
          echo "üîç Detecting migration changes..."

          # Get list of changed SQL files in migrations folder
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- supabase/migrations/*.sql || echo "")

          if [ -n "$CHANGED_FILES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìù Changed migrations:"
            echo "$CHANGED_FILES"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No migration changes detected"
          fi

      - name: Setup Supabase CLI
        if: steps.detect-changes-staging.outputs.has_changes == 'true'
        uses: supabase/setup-cli@v1
        with:
          version: 1.178.2

      - name: Apply to staging
        if: steps.detect-changes-staging.outputs.has_changes == 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_STAGING_PROJECT_ID: ${{ secrets.SUPABASE_STAGING_PROJECT_ID }}
          SUPABASE_STAGING_DB_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
        run: |
          echo "üîÑ Applying migrations to staging..."

          if [ -n "$SUPABASE_STAGING_PROJECT_ID" ]; then
            supabase link --project-ref $SUPABASE_STAGING_PROJECT_ID
            supabase db push --password $SUPABASE_STAGING_DB_PASSWORD
            echo "‚úÖ Staging migrations applied"
          else
            echo "‚ö†Ô∏è  No staging environment configured, skipping"
          fi
